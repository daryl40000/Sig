# Changelog - Module SIG

## Version 0.6 (2025-09-22)

### üöÄ **Fonctionnalit√©s majeures : Projections de tr√©sorerie et comparaison historique**

#### üìà **Projections de tr√©sorerie avec zone d'incertitude**
- ‚úÖ **Zones color√©es** : Colorisation automatique positive (vert) / n√©gative (rouge) dans le graphique de tr√©sorerie
- ‚úÖ **Courbes de projection** : Projections optimiste (verte) et pessimiste (rouge) √† partir du mois en cours
- ‚úÖ **Zone d'incertitude** : Zone jaune transparente entre les projections
- ‚úÖ **Incertitude configurable** : Nouvelle option "Incertitude des projections" (d√©faut: 1000‚Ç¨)
- ‚úÖ **Progression lin√©aire** : ¬±1000‚Ç¨ le 1er mois, ¬±2000‚Ç¨ le 2√®me mois, etc.

#### üìä **Comparaison historique avec ann√©e N-1**
- ‚úÖ **Ligne CA N-1** : Affichage automatique de l'ann√©e pr√©c√©dente dans le tableau
- ‚úÖ **Ligne de diff√©rence** : Calcul et colorisation des √©carts (vert=am√©lioration, rouge=baisse)
- ‚úÖ **Saisie manuelle** : Interface pour saisir les CA des ann√©es pr√©c√©dentes si pas de donn√©es Dolibarr
- ‚úÖ **Graphique comparatif** : Nouveau graphique avec courbes ann√©e courante vs ann√©e pr√©c√©dente
- ‚úÖ **Logique intelligente** : Priorit√© aux donn√©es r√©elles, fallback sur donn√©es manuelles

#### üé® **Optimisations interface**
- ‚úÖ **Page index √©pur√©e** : Suppression du tableau des devis sign√©s (information redondante)
- ‚úÖ **Performance** : R√©duction des requ√™tes SQL et optimisation du chargement

### üîß **Am√©liorations techniques**

#### Configuration
- **Nouvelle constante** : `SIG_PROJECTION_UNCERTAINTY` (valeur d'incertitude)
- **Stockage JSON** : `SIG_MANUAL_CA_[ANN√âE]` pour les donn√©es manuelles
- **Interface admin** : Nouvelle section "Saisie manuelle des CA des ann√©es pr√©c√©dentes"

#### Fonctions ajout√©es
- `sig_get_manual_turnover_for_month()` : R√©cup√©ration des donn√©es manuelles
- Gestion robuste des erreurs et validation des donn√©es

#### JavaScript optimis√©
- **Gestion d'erreurs** : V√©rifications de chargement Chart.js et existence des √©l√©ments
- **Code all√©g√©** : Simplification des fonctions dynamiques
- **Performance** : Optimisation du rendu des graphiques

### üåê **Traductions ajout√©es**
- `SigProjectionUncertainty` : Incertitude des projections
- `SigManualTurnoverSection` : Saisie manuelle des CA des ann√©es pr√©c√©dentes
- `SigManualTurnoverTitle` : Chiffre d'affaires manuel pour %s
- `SigManualTurnoverHelp` : Texte d'aide pour la saisie manuelle

### üìã **Migration et compatibilit√©**
- **R√©trocompatible** : Aucune modification de base de donn√©es requise
- **Configuration automatique** : Valeurs par d√©faut pour les nouvelles options
- **Donn√©es existantes** : Pr√©servation compl√®te des donn√©es actuelles

---

## Version 0.5 (2025-09-21)

### üöÄ **Nouvelle fonctionnalit√© majeure : Factures mod√®le client**

#### Fonctionnalit√© ajout√©e
- ‚úÖ **Inclusion des factures mod√®le client** dans les encaissements pr√©visionnels de tr√©sorerie
- ‚úÖ **Gestion intelligente de la fr√©quence** : Mensuelle, trimestrielle, semestrielle, annuelle
- ‚úÖ **Calcul automatique de la marge** bas√© sur le taux de marge configur√© dans le module
- ‚úÖ **Configuration granulaire** via une nouvelle option dans la section Tr√©sorerie

#### Impl√©mentation technique
- **Nouvelle option de configuration** : "Inclure les factures mod√®le client" (`SIG_INCLUDE_CUSTOMER_TEMPLATE_INVOICES`)
- **Table utilis√©e** : `llx_facture_rec` (factures r√©currentes Dolibarr)
- **Nouvelles fonctions** :
  - `sig_get_customer_template_invoices_for_month()` : Calcul de la marge mensuelle
  - `sig_should_generate_template_invoice_for_month()` : Logique de fr√©quence
  - `sig_get_customer_template_invoices_details_for_month()` : Support diagnostic

#### Logique de calcul
- **Formule** : Marge = Montant HT √ó Taux de marge configur√©
- **Fr√©quence mensuelle** : Marge compt√©e tous les mois
- **Fr√©quence trimestrielle** : Marge compt√©e tous les 3 mois (janv, avril, juillet, oct)
- **Fr√©quence annuelle** : Marge compt√©e une fois par an selon la date de r√©f√©rence

#### Interface utilisateur
- **Affichage** : Ligne "Factures mod√®le: +X‚Ç¨" en orange (#FF9800) dans les encaissements
- **Int√©gration** : Prise en compte dans tous les calculs de solde et totaux
- **Configuration** : Case √† cocher native Dolibarr dans admin/setup.php

#### Corrections importantes
- ‚úÖ **Logique temporelle corrig√©e** : Marge compt√©e le mois de g√©n√©ration (pas d'encaissement)
- ‚úÖ **Restriction aux mois futurs** : Factures mod√®le appliqu√©es seulement √† partir du mois actuel
- ‚úÖ **√âvitement du double comptage** : Pas de prise en compte des factures d√©j√† g√©n√©r√©es

#### Formule de tr√©sorerie mise √† jour
```
Solde fin = Solde d√©but + Encaissements + Factures client + Factures mod√®le + Marge pr√©c√©dente - D√©caissements - Salaires impay√©s
```

#### Configuration requise
- **Activation** : Cocher "Inclure les factures mod√®le client" dans Configuration > Modules > SIG
- **Pr√©requis** : Module factures r√©currentes Dolibarr activ√© avec factures mod√®le configur√©es
- **Taux de marge** : Utilise le taux configur√© dans le module (d√©faut : 20%)

---

## Version 0.41 (2025-09-21)

### üêõ **Correction critique : Calcul du solde de fin de mois**

#### Probl√®me corrig√©
- ‚úÖ **Erreur majeure** : Les salaires impay√©s n'√©taient pas pris en compte dans le calcul du solde de fin de mois
- ‚úÖ **Impact** : Le solde de fin de mois √©tait sur√©valu√© car les salaires impay√©s √©taient affich√©s mais pas d√©duits du calcul
- ‚úÖ **Solution** : Ajout de `- $salaires_impayes_mois` dans la formule de calcul du solde

#### D√©tail technique
- **Fichier modifi√©** : `tresorerie.php` (ligne 179)
- **Avant** : `$solde_fin_mois = $solde_debut_mois + $encaissements_mois + $factures_client_mois + $marge_mois_precedent - $decaissements_mois;`
- **Apr√®s** : `$solde_fin_mois = $solde_debut_mois + $encaissements_mois + $factures_client_mois + $marge_mois_precedent - $decaissements_mois - $salaires_impayes_mois;`

#### Impact de la correction
- ‚úÖ **Solde de fin de mois** : Maintenant exact et pr√©cis
- ‚úÖ **Pr√©visions de tr√©sorerie** : D√©sormais fiables
- ‚úÖ **Configuration** : Aucune modification requise, correction automatique si l'option "Inclure les salaires impay√©s" est activ√©e

---

## Version 0.4 (2025-09-21)

### üöÄ Refonte majeure de la page tr√©sorerie

#### Page de tr√©sorerie √©pur√©e et optimis√©e
- ‚úÖ **Suppression des sections redondantes** : Suppression des bo√Ætes "CA Encaiss√©" et "CA Potentiel" (disponibles sur leur page d√©di√©e)
- ‚úÖ **Suppression de la section "Solde Bancaire"** : Informations redondantes avec le tableau principal
- ‚úÖ **Interface simplifi√©e** : Page focalis√©e uniquement sur l'√©volution de la tr√©sorerie

#### Graphique interactif des soldes
- ‚úÖ **Nouveau graphique Chart.js** : Visualisation de l'√©volution des soldes de fin de mois sur l'ann√©e
- ‚úÖ **Design moderne** : Graphique en ligne avec zone remplie, couleurs coh√©rentes avec l'interface
- ‚úÖ **Interactivit√©** : Survol pour voir les valeurs exactes, formatage en euros
- ‚úÖ **Responsive** : Adaptation automatique √† la taille de l'√©cran

#### Am√©lioration des donn√©es pour les mois pass√©s
- ‚úÖ **Donn√©es exactes du module banque** : Pour les mois √©coul√©s, utilisation des donn√©es r√©elles du module banque Dolibarr
- ‚úÖ **Fonction d√©di√©e** : `sig_get_bank_movements_real_for_month()` pour r√©cup√©rer uniquement les mouvements bancaires r√©els
- ‚úÖ **Soldes coh√©rents** : Les soldes de fin des mois pass√©s correspondent exactement au module banque

#### Correction de la logique pr√©visionnelle
- ‚úÖ **Mois en cours corrig√©** : Inclusion des factures qui arrivent √† √©ch√©ance dans le mois en cours (et pas seulement celles en retard)
- ‚úÖ **Roll-over des retards** : Les factures/salaires en retard des mois pass√©s sont report√©s au mois actuel
- ‚úÖ **Calcul pr√©visionnel optimis√©** : Nouvelle formule pour le solde fin = Solde d√©but + Encaissements + Factures client + Marge mois pr√©c√©dent - D√©caissements

#### Simplification de l'affichage
- ‚úÖ **Colonne "Solde Fin" simplifi√©e** : Affichage direct du solde pr√©visionnel sans d√©tails des composants
- ‚úÖ **Code nettoy√©** : Suppression de toutes les lignes de diagnostic temporaires

### üîß Am√©liorations techniques

#### Nouvelles fonctions
- ‚úÖ **`sig_get_bank_movements_real_for_month()`** : R√©cup√©ration des mouvements bancaires r√©els uniquement
- ‚úÖ **Collecte de donn√©es pour graphique** : Tableaux `$mois_labels` et `$soldes_data`

#### Fonctions supprim√©es (optimisation)
- ‚ùå **`sig_get_total_turnover_for_year()`** : Fonction non utilis√©e supprim√©e
- ‚ùå **`sig_get_total_expected_turnover_for_year()`** : Fonction non utilis√©e supprim√©e

#### Logique am√©lior√©e
- ‚úÖ **Distinction mois √©coul√©s/futurs** : Logique claire avec `$is_past_month`
- ‚úÖ **Affichage conditionnel** : Les encaissements/d√©caissements utilisent les bonnes donn√©es selon le type de mois
- ‚úÖ **Correction des dates d'√©ch√©ance** : Pour le mois en cours, inclusion de toutes les factures jusqu'√† la fin du mois

### üìä Interface utilisateur
- ‚úÖ **Graphique de 400px de hauteur** : Bonne lisibilit√© des tendances
- ‚úÖ **Titre dynamique** : "√âvolution des Soldes de Fin de Mois - [Ann√©e]"
- ‚úÖ **Formatage fran√ßais** : Devise en euros avec s√©parateurs appropri√©s
- ‚úÖ **CDN Chart.js** : Chargement moderne de la biblioth√®que graphique

---

## Version 0.35 (2025-09-21)

### ‚úÖ Nouvelles fonctionnalit√©s

#### Gestion des salaires impay√©s
- ‚úÖ **Option "Inclure les salaires impay√©s"** : Contr√¥le l'inclusion des salaires impay√©s dans les d√©caissements √† venir
- ‚úÖ **Fonction optimis√©e** : Cr√©ation d'une requ√™te propre `sig_get_unpaid_salaries_for_month()` pour r√©cup√©rer les salaires impay√©s par mois
- ‚úÖ **Affichage d√©taill√©** : Les salaires impay√©s sont affich√©s dans la colonne des d√©caissements avec code couleur violet (#9C27B0)
- ‚úÖ **Calculs corrects** : Utilisation de la colonne `dateep` (date de fin de p√©riode) pour affecter chaque salaire au bon mois
- ‚úÖ **Totaux annuels** : Prise en compte des salaires impay√©s dans les totaux de fin d'ann√©e

### üîß Am√©liorations techniques
- ‚úÖ **Requ√™te SQL optimis√©e** : `WHERE paye = 0` pour identifier les salaires impay√©s
- ‚úÖ **Filtrage par mois** : Utilisation de `dateep >= 'YYYY-MM-01' AND dateep <= 'YYYY-MM-31'` pour la r√©partition mensuelle
- ‚úÖ **Int√©gration native** : Respect de l'option de configuration `SIG_INCLUDE_UNPAID_SALARIES`
- ‚úÖ **Code propre** : Suppression des diagnostics temporaires et optimisation des performances

### üìä Configuration
- ‚úÖ **Option de configuration** : "Inclure les salaires impay√©s" dans la section Tr√©sorerie (admin/setup.php)
- ‚úÖ **Activation/d√©sactivation** : Case √† cocher native Dolibarr pour activer ou d√©sactiver la fonctionnalit√©
- ‚úÖ **Constante Dolibarr** : `SIG_INCLUDE_UNPAID_SALARIES` de type `yesno`

### üìà Fonctionnement
- **Table utilis√©e** : `llx_salary`
- **Crit√®re d'impay√©** : `paye = 0`
- **Date de r√©f√©rence** : `dateep` (date de fin de p√©riode)
- **Montant** : `amount` (montant du salaire)
- **Affichage** : Dans la colonne "D√©caissements" du tableau de tr√©sorerie

---

## Version 0.3 (2025-01-XX)

### üéØ Nouvelles fonctionnalit√©s

#### Configuration avanc√©e de la tr√©sorerie
- ‚úÖ **Option "Inclure les factures fournisseurs"** : Contr√¥le l'inclusion des factures fournisseurs et charges fiscales/sociales dans les factures fournisseurs
- ‚úÖ **Option "Inclure les charges sociales"** : Contr√¥le l'inclusion des charges sociales du module Sociales (URSSAF, retraite, etc.)
- ‚úÖ **Option "Inclure les devis sign√©s"** : Contr√¥le l'inclusion des devis sign√©s dans les encaissements √† venir (marge avec d√©lai de paiement)
- ‚úÖ **Option "Inclure les factures client impay√©es"** : Contr√¥le l'inclusion des factures client impay√©es dans les encaissements √† venir (bas√© sur la date de r√®glement pr√©vue)

#### Am√©liorations de l'interface
- ‚úÖ **Interface de configuration native** : Utilisation des cases √† cocher Dolibarr standard
- ‚úÖ **Affichage de l'√©tat** : Configuration actuelle visible dans l'interface
- ‚úÖ **S√©paration des options** : Contr√¥le ind√©pendant de chaque type d'√©l√©ment

#### Optimisations du code
- ‚úÖ **Suppression des diagnostics** : Nettoyage du code source (suppression de ~500 lignes de code de diagnostic)
- ‚úÖ **Performance am√©lior√©e** : Plus d'ex√©cution de requ√™tes inutiles
- ‚úÖ **Code source plus propre** : HTML plus l√©ger et plus rapide √† charger

### üîß Modifications techniques

#### Nouvelles constantes de configuration
- `SIG_INCLUDE_SUPPLIER_INVOICES` : Inclure les factures fournisseurs (yesno)
- `SIG_INCLUDE_SOCIAL_CHARGES` : Inclure les charges sociales (yesno)
- `SIG_INCLUDE_SIGNED_QUOTES` : Inclure les devis sign√©s (yesno)
- `SIG_INCLUDE_CUSTOMER_INVOICES` : Inclure les factures client impay√©es (yesno)

#### Nouvelles fonctions
- `sig_get_customer_invoices_for_month()` : R√©cup√®re les factures client impay√©es par mois
- `sig_get_sociales_charges_for_month()` : R√©cup√®re les charges sociales du module Sociales
- `sig_get_chargesociales_for_month()` : R√©cup√®re les charges sociales depuis la table chargesociales

#### Modifications des fonctions existantes
- `sig_get_expected_margin_for_month()` : Respecte l'option SIG_INCLUDE_SIGNED_QUOTES
- `sig_get_expected_margin_with_delay_for_month()` : Respecte l'option SIG_INCLUDE_SIGNED_QUOTES
- `sig_get_bank_movements_details_for_month()` : Int√®gre les nouvelles options de configuration

### üìä Logique de calcul mise √† jour

#### Colonne "Encaissements"
- Mouvements bancaires r√©els
- + Marge pr√©vue (si devis sign√©s activ√©s)
- + Factures client impay√©es (si factures client activ√©es)

#### Colonne "D√©caissements"
- Mouvements bancaires r√©els
- + Factures fournisseurs (si factures fournisseurs activ√©es)
- + Charges sociales (si charges sociales activ√©es)

#### Colonne "Solde fin th√©orique"
- Solde d√©but + Encaissements - D√©caissements
- + Marge avec d√©lai (si devis sign√©s activ√©s)
- + Factures client impay√©es (si factures client activ√©es)

### üéõÔ∏è Sc√©narios d'utilisation

1. **Analyse compl√®te** : Toutes les options coch√©es
2. **Analyse r√©aliste** : Seulement les mouvements r√©els (toutes options d√©coch√©es)
3. **Analyse partielle** : Combinaisons selon les besoins
4. **Analyse conservatrice** : Seulement les factures fournisseurs et charges sociales

### üêõ Corrections de bugs

- ‚úÖ **Affichage des devis sign√©s** : Correction de l'affichage de la marge des devis sign√©s dans la colonne encaissements
- ‚úÖ **Coh√©rence des options** : Toutes les options respectent maintenant leur √©tat activ√©/d√©sactiv√©
- ‚úÖ **Calcul des totaux** : Les totaux incluent correctement tous les √©l√©ments selon les options

### üìù Traductions ajout√©es

- `SigTreasurySection` : Section Tr√©sorerie
- `SigIncludeSupplierInvoices` : Inclure les factures fournisseurs
- `SigIncludeSupplierInvoicesHelp` : Aide pour l'option factures fournisseurs
- `SigIncludeSocialCharges` : Inclure les charges sociales
- `SigIncludeSocialChargesHelp` : Aide pour l'option charges sociales
- `SigIncludeSignedQuotes` : Inclure les devis sign√©s
- `SigIncludeSignedQuotesHelp` : Aide pour l'option devis sign√©s
- `SigIncludeCustomerInvoices` : Inclure les factures client impay√©es
- `SigIncludeCustomerInvoicesHelp` : Aide pour l'option factures client

---

## Version 0.2 (2025-01-XX)

### üéØ Fonctionnalit√©s de base

- ‚úÖ **Tableau de tr√©sorerie** : Affichage mensuel des mouvements bancaires
- ‚úÖ **Calcul des marges** : Int√©gration des devis sign√©s avec d√©lai de paiement
- ‚úÖ **Configuration de base** : Compte bancaire, taux de marge, d√©lai de paiement
- ‚úÖ **Interface utilisateur** : Tableau responsive avec couleurs et totaux

### üîß Fonctionnalit√©s techniques

- ‚úÖ **Int√©gration Dolibarr** : Module natif avec droits et configuration
- ‚úÖ **Requ√™tes optimis√©es** : R√©cup√©ration efficace des donn√©es bancaires
- ‚úÖ **Gestion des entit√©s** : Respect des filtres d'entit√© Dolibarr
- ‚úÖ **Calculs automatiques** : Solde fin th√©orique et variations

---

## Version 0.1 (2025-01-XX)

### üéØ Version initiale

- ‚úÖ **Structure du module** : Cr√©ation de la base du module SIG
- ‚úÖ **Configuration** : Interface de configuration de base
- ‚úÖ **Fonctionnalit√©s** : Premi√®re version du tableau de tr√©sorerie